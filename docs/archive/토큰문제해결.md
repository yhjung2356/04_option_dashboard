# í† í° Rate Limit ë¬¸ì œ í•´ê²° ì™„ë£Œ (2025-12-20)

## ğŸ” ë¬¸ì œ ë¶„ì„

### ì—ëŸ¬ ë‚´ìš©
```
ERROR: Failed to get access token: 403 - {"error_code":"EGW00133"}
â†’ "í† í° ë°œê¸‰ ìš”ì²­ ì‹œ 1ë¶„ë‹¹ 1íšŒ ì¬ì‹œë„í•˜ì„¸ìš”"
```

### ì›ì¸
1. **ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ë§ˆë‹¤ ìƒˆ í† í° ë°œê¸‰ ì‹œë„**
2. **í•œêµ­íˆ¬ìì¦ê¶Œ APIëŠ” 1ë¶„ë‹¹ 1íšŒë§Œ í† í° ë°œê¸‰ í—ˆìš©**
3. **ê°œë°œ ì¤‘ ë¹ˆë²ˆí•œ ì¬ì‹œì‘ìœ¼ë¡œ Rate Limit ì´ˆê³¼**

### ë°œìƒ ìƒí™©
```
22:56:16 - í† í° ë°œê¸‰ ì„±ê³µ âœ“
22:58:13 - ì¬ì‹œì‘ â†’ Rate Limit ì—ëŸ¬ âœ—
22:58:48 - ì¬ì‹œì‘ â†’ Rate Limit ì—ëŸ¬ âœ—
```

## âœ… í•´ê²° ë°©ë²•

### 1. í† í° íŒŒì¼ ìºì‹±
```java
// í† í°ì„ íŒŒì¼ì— ì €ì¥ (ì¬ì‹œì‘ í›„ì—ë„ ì¬ì‚¬ìš©)
private void saveTokenToFile(String token, LocalDateTime expiry) {
    String tokenData = token + "|" + expiry.toString();
    Files.writeString(Path.of("kis_token.cache"), tokenData);
}
```

### 2. 3ë‹¨ê³„ í† í° ë¡œë“œ ì „ëµ
```java
public String getAccessToken() {
    // 1ë‹¨ê³„: ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸
    if (accessToken != null && LocalDateTime.now().isBefore(tokenExpiry)) {
        return accessToken; // ê°€ì¥ ë¹ ë¦„
    }

    // 2ë‹¨ê³„: íŒŒì¼ ìºì‹œ í™•ì¸
    String cachedToken = loadTokenFromFile();
    if (cachedToken != null) {
        return cachedToken; // ì¬ì‹œì‘ í›„ì—ë„ ë™ì‘
    }

    // 3ë‹¨ê³„: ìƒˆ í† í° ë°œê¸‰
    // ... API í˜¸ì¶œ
}
```

### 3. Rate Limit ì—ëŸ¬ ì‹œ Fallback
```java
if (responseBody.contains("EGW00133")) {
    log.warn("Rate limit exceeded. Attempting to use any cached token...");
    String forcedToken = loadTokenFromFile(true); // ë§Œë£Œëœ í† í°ì´ë¼ë„ ì‹œë„
    if (forcedToken != null) {
        return forcedToken; // ì‘ë™í•  ìˆ˜ ìˆìŒ
    }
}
```

## ğŸ“Š ìˆ˜ì •ëœ ì½”ë“œ

### `KisApiService.java`

#### í† í° ë°œê¸‰ ë©”ì„œë“œ (`getAccessToken`)
```java
public String getAccessToken() {
    // 1ï¸âƒ£ ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸
    if (accessToken != null && tokenExpiry != null && 
        LocalDateTime.now().isBefore(tokenExpiry)) {
        log.debug("Using cached access token");
        return accessToken;
    }

    // 2ï¸âƒ£ íŒŒì¼ ìºì‹œ í™•ì¸
    String cachedToken = loadTokenFromFile();
    if (cachedToken != null) {
        log.info("âœ“ Using cached token from file");
        return cachedToken;
    }

    // 3ï¸âƒ£ ìƒˆ í† í° ë°œê¸‰ ì‹œë„
    // ... API í˜¸ì¶œ ...

    // 4ï¸âƒ£ Rate Limit ì—ëŸ¬ ì²˜ë¦¬
    if (responseBody.contains("EGW00133")) {
        String forcedToken = loadTokenFromFile(true);
        if (forcedToken != null) {
            return forcedToken;
        }
    }
}
```

#### íŒŒì¼ ì €ì¥/ë¡œë“œ ë©”ì„œë“œ
```java
private void saveTokenToFile(String token, LocalDateTime expiry) {
    try {
        String tokenData = token + "|" + expiry.toString();
        Files.writeString(
            Path.of("kis_token.cache"), 
            tokenData, 
            StandardCharsets.UTF_8
        );
        log.debug("Token saved to file");
    } catch (Exception e) {
        log.warn("Failed to save token: {}", e.getMessage());
    }
}

private String loadTokenFromFile(boolean ignoreExpiry) {
    try {
        Path path = Path.of("kis_token.cache");
        if (!Files.exists(path)) {
            return null;
        }

        String tokenData = Files.readString(path, StandardCharsets.UTF_8);
        String[] parts = tokenData.split("\\|");
        
        String token = parts[0];
        LocalDateTime expiry = LocalDateTime.parse(parts[1]);

        // ë§Œë£Œ ì²´í¬ (ì˜µì…˜)
        if (!ignoreExpiry && LocalDateTime.now().isAfter(expiry)) {
            return null;
        }

        accessToken = token;
        tokenExpiry = expiry;
        return token;
        
    } catch (Exception e) {
        return null;
    }
}
```

## ğŸ¯ ì‘ë™ ë°©ì‹

### ì²« ì‹¤í–‰ (í† í° ì—†ìŒ)
```
1. ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸ â†’ ì—†ìŒ
2. íŒŒì¼ ìºì‹œ í™•ì¸ â†’ ì—†ìŒ
3. API í˜¸ì¶œ â†’ ì„±ê³µ âœ“
4. íŒŒì¼ì— ì €ì¥: kis_token.cache
   ë‚´ìš©: eyJ0eXAiOiJKV1...|2025-12-21T22:58:16
```

### ì¬ì‹œì‘ (í† í° ìˆìŒ)
```
1. ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸ â†’ ì—†ìŒ (ì¬ì‹œì‘ìœ¼ë¡œ ì´ˆê¸°í™”ë¨)
2. íŒŒì¼ ìºì‹œ í™•ì¸ â†’ ë°œê²¬! âœ“
3. íŒŒì¼ì—ì„œ ë¡œë“œ:
   - í† í°: eyJ0eXAiOiJKV1...
   - ë§Œë£Œì‹œê°„: 2025-12-21T22:58:16
4. ë§Œë£Œ í™•ì¸: ì•„ì§ ìœ íš¨ â†’ ì¬ì‚¬ìš© âœ“
```

### Rate Limit ë°œìƒ ì‹œ
```
1. ë©”ëª¨ë¦¬ ìºì‹œ â†’ ì—†ìŒ
2. íŒŒì¼ ìºì‹œ â†’ ë§Œë£Œë¨
3. API í˜¸ì¶œ â†’ 403 Rate Limit âœ—
4. Fallback: ë§Œë£Œëœ í† í°ì´ë¼ë„ ì‹œë„
5. íŒŒì¼ì—ì„œ ê°•ì œ ë¡œë“œ (ignoreExpiry=true)
6. ì‚¬ìš© ì‹œë„ â†’ ì‘ë™í•  ìˆ˜ ìˆìŒ âœ“
```

## ğŸ“ ìƒì„±ë˜ëŠ” íŒŒì¼

### `kis_token.cache`
```
ìœ„ì¹˜: D:\Workspace\Spring\futures-options-dashboard\kis_token.cache
í˜•ì‹: {í† í°}|{ë§Œë£Œì‹œê°„}
ì˜ˆì‹œ: eyJ0eXAiOiJKV1QiLCJhbGc...|2025-12-21T22:58:16.511
```

**ì£¼ì˜**: ì´ íŒŒì¼ì€ `.gitignore`ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤!

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### .gitignoreì— ì¶”ê°€
```gitignore
# í† í° ìºì‹œ íŒŒì¼
kis_token.cache
```

### í† í° ìœ íš¨ê¸°ê°„
- **ê¸°ë³¸ ìœ íš¨ê¸°ê°„**: 86400ì´ˆ (24ì‹œê°„)
- **ìë™ ê°±ì‹ **: ë§Œë£Œ ì‹œ ìë™ìœ¼ë¡œ ìƒˆ í† í° ë°œê¸‰
- **Rate Limit**: 1ë¶„ë‹¹ 1íšŒë§Œ ë°œê¸‰ ê°€ëŠ¥

## ğŸ‰ ê¸°ëŒ€ íš¨ê³¼

### Before (ë¬¸ì œ ìƒí™©)
```
âŒ ì¬ì‹œì‘ë§ˆë‹¤ Rate Limit ì—ëŸ¬ ë°œìƒ
âŒ 1ë¶„ ê¸°ë‹¤ë ¤ì•¼ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
âŒ ê°œë°œ íš¨ìœ¨ ì €í•˜
```

### After (í•´ê²° í›„)
```
âœ… ì¬ì‹œì‘ í›„ ì¦‰ì‹œ í† í° ì‚¬ìš© ê°€ëŠ¥
âœ… 24ì‹œê°„ ë™ì•ˆ í† í° ì¬ì‚¬ìš©
âœ… Rate Limit ê±±ì • ì—†ìŒ
âœ… ê°œë°œ íš¨ìœ¨ í–¥ìƒ
```

## ğŸ“ ë¡œê·¸ ê°œì„ 

### ì„±ê³µ ë¡œê·¸
```
INFO: Using cached access token (expires at 2025-12-21T22:58:16)
INFO: âœ“ Using cached token from file (expires at 2025-12-21T22:58:16)
INFO: âœ“ Access token obtained successfully! Expires in 86400 seconds
```

### Rate Limit ë¡œê·¸
```
ERROR: Failed to get access token: 403 - {"error_code":"EGW00133"}
WARN: Rate limit exceeded. Attempting to use any cached token...
INFO: âœ“ Using potentially expired token from cache
```

## ğŸš€ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì •ìƒ ì‘ë™
```bash
# ì²« ì‹¤í–‰
mvnw spring-boot:run
â†’ INFO: âœ“ Access token obtained successfully!

# ì¦‰ì‹œ ì¬ì‹œì‘
Ctrl+C
mvnw spring-boot:run
â†’ INFO: âœ“ Using cached token from file
```

### 2. Rate Limit ë°œìƒ
```bash
# ë¹ ë¥¸ ì—°ì† ì¬ì‹œì‘ (1ë¶„ ì´ë‚´)
mvnw spring-boot:run  # í† í° ë°œê¸‰ ì„±ê³µ
Ctrl+C
mvnw spring-boot:run  # ìºì‹œì—ì„œ ë¡œë“œ âœ“
Ctrl+C
rm kis_token.cache   # ìºì‹œ ì‚­ì œ
mvnw spring-boot:run  # Rate Limit â†’ Fallback ì‘ë™
```

### 3. í† í° ë§Œë£Œ
```bash
# 24ì‹œê°„ í›„
mvnw spring-boot:run
â†’ INFO: Cached token expired
â†’ INFO: Requesting new access token from KIS API...
â†’ INFO: âœ“ Access token obtained successfully!
```

## ğŸŠ ìµœì¢… ì™„ë£Œ!

### âœ… ì™„ë£Œëœ ì‘ì—…
1. **í† í° íŒŒì¼ ìºì‹± êµ¬í˜„**
2. **3ë‹¨ê³„ í† í° ë¡œë“œ ì „ëµ**
3. **Rate Limit Fallback ì²˜ë¦¬**
4. **ë¹Œë“œ ì„±ê³µ**

### ğŸ“¦ íŒŒì¼ ë³€ê²½
- âœ… `KisApiService.java` - í† í° ìºì‹± ë¡œì§ ì¶”ê°€ (3ê°œ ë©”ì„œë“œ)
- âœ… ë¹Œë“œ ì„±ê³µ: BUILD SUCCESS

### ğŸ¯ ê²°ê³¼
**ì´ì œ ì¬ì‹œì‘í•´ë„ Rate Limit ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!** ğŸš€

---

**ì‘ì„±ì¼**: 2025-12-20  
**í•´ê²° ì‹œê°„**: ì•½ 5ë¶„  
**ìƒíƒœ**: âœ… ì™„ë£Œ
