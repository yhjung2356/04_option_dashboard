# 📊 데이터 소스 설명

## 🎯 데이터 출처

이 대시보드는 **실제 KRX(한국거래소) 데이터**를 사용합니다!

---

## 1️⃣ KRX 정보데이터시스템 API

### 📍 API 엔드포인트
```
POST http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd
```

### 📈 KOSPI200 선물 데이터

**API 코드:** `MDCSTAT30301`

**요청 파라미터:**
```
bld=dbms/MDC/STAT/standard/MDCSTAT30301
locale=ko_KR
trdDd=20251219        # 거래일 (YYYYMMDD)
prodId=1              # KOSPI200 선물
share=1
money=1
```

**응답 데이터:**
| 필드 | 설명 |
|------|------|
| ISU_SRT_CD | 종목코드 (예: 202501, 202502) |
| ISU_ABBRV | 종목명 (예: KOSPI200 선물 2501) |
| TDD_CLSPRC | 종가 |
| TDD_OPNPRC | 시가 |
| TDD_HGPRC | 고가 |
| TDD_LWPRC | 저가 |
| ACC_TRDVOL | 거래량 |
| ACC_TRDVAL | 거래대금 |
| OPNINT_QTY | 미결제약정 |
| CMPPREVDD_PRC | 전일대비 |
| FLUC_RT | 등락률 |

### 📊 KOSPI200 옵션 데이터

**API 코드:** `MDCSTAT30401`

**요청 파라미터:**
```
bld=dbms/MDC/STAT/standard/MDCSTAT30401
locale=ko_KR
trdDd=20251219
prodId=1              # KOSPI200 옵션
share=1
money=1
```

**응답 데이터:**
| 필드 | 설명 |
|------|------|
| ISU_SRT_CD | 종목코드 |
| ISU_CD | 상품코드 (콜/풋 구분) |
| X_PRC | 행사가 |
| TDD_CLSPRC | 종가 |
| ACC_TRDVOL | 거래량 |
| ACC_TRDVAL | 거래대금 |
| OPNINT_QTY | 미결제약정 |
| IMP_VLAT | 내재변동성 (IV) |

---

## 2️⃣ 전거래일 계산 로직

### 영업일 기준 전거래일

```java
LocalDate today = LocalDate.now();
LocalDate previousDay = today.minusDays(1);

// 토요일(6) 또는 일요일(7)이면 건너뛰기
while (previousDay.getDayOfWeek().getValue() >= 6) {
    previousDay = previousDay.minusDays(1);
}

return previousDay.format("yyyyMMdd");
```

### 예시

| 오늘 | 전거래일 |
|------|----------|
| 2025-12-20 (토) | 2025-12-19 (금) |
| 2025-12-21 (일) | 2025-12-19 (금) |
| 2025-12-22 (월) | 2025-12-19 (금) |
| 2025-12-23 (화) | 2025-12-22 (월) |

---

## 3️⃣ 데이터 로딩 흐름

### 애플리케이션 시작 시

```
┌─────────────────────────────────────┐
│  1️⃣ 애플리케이션 시작               │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│  2️⃣ DB에 기존 데이터 있는지 확인   │
│     (H2 메모리 DB)                  │
└─────────────────┬───────────────────┘
                  │
          ┌───────┴───────┐
          │ 데이터 없음?   │
          └───────┬───────┘
                  │ Yes
┌─────────────────▼───────────────────┐
│  3️⃣ 전거래일 계산                   │
│     예: 오늘 토요일 → 금요일         │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│  4️⃣ KRX API 호출 시도               │
│     • 선물 데이터 요청               │
│     • 옵션 데이터 요청               │
└─────────────────┬───────────────────┘
                  │
          ┌───────┴───────┐
          │  성공?         │
          └───┬───────┬───┘
          Yes │       │ No
    ┌─────────▼──┐  ┌─▼──────────────┐
    │ 5️⃣ 실제    │  │ 5️⃣ 샘플       │
    │    데이터  │  │    데이터      │
    │    저장 ✅ │  │    생성 ⚠️     │
    └─────────┬──┘  └─┬──────────────┘
              │       │
    ┌─────────▼───────▼──────────────┐
    │  6️⃣ DB 저장 (H2 메모리)        │
    └─────────┬───────────────────────┘
              │
    ┌─────────▼───────────────────────┐
    │  7️⃣ 웹 대시보드에서 확인 가능   │
    │     http://localhost:8080       │
    └─────────────────────────────────┘
```

---

## 4️⃣ 실시간 갱신 (장 시간 중)

### 주간장: 09:00 ~ 15:45

```
DataSimulationService 활성화
    ↓
@Scheduled(fixedRate = 1000)  ← 1초마다
    ↓
새 데이터 생성 (시뮬레이션)
    ↓
WebSocket 브로드캐스트
    ↓
화면 자동 갱신 ⚡
```

### 야간장: 18:00 ~ 05:00

```
동일하게 1초마다 갱신
```

---

## 5️⃣ 장 마감 시 동작

### 15:45 or 05:00 이후

```java
if (!isMarketOpen()) {
    log.debug("Market is closed. Displaying last trading day data.");
    return;  // 데이터 생성 중단, 기존 데이터 유지!
}

// 장이 열렸을 때만 실행
optionDataRepository.deleteAll();
futuresDataRepository.deleteAll();
// ... 새 데이터 생성
```

**결과:**
- ✅ 데이터 삭제 안 함
- ✅ 전거래일 데이터 유지
- ✅ 화면에 계속 표시

---

## 6️⃣ 설정 (application.properties)

```properties
# 데이터 소스 선택
trading.data-source=KRX           # 실제 KRX 데이터
# trading.data-source=SAMPLE      # 샘플 데이터만

# 장 시간 체크
trading.market-hours.enabled=true  # 장 시간만 갱신
# trading.market-hours.enabled=false  # 24시간 갱신 (테스트)

# 데모 모드
trading.demo-mode=false           # 실전 모드
# trading.demo-mode=true          # 데모 (장 시간 무시)

# KRX API 주소
trading.krx.api-url=http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd
```

---

## 7️⃣ 로그 확인

### 성공 시 (KRX 데이터 로드)

```
INFO  - ========================================
INFO  - Loading initial market data (Previous Trading Day)...
INFO  - ========================================
INFO  - Attempting to load real KRX data...
INFO  - ========================================
INFO  - Loading KRX data for date: 20251219
INFO  - ========================================
INFO  - Loading KOSPI200 Futures data...
INFO  - ✓ Loaded 6 KOSPI200 futures contracts
INFO  - Loading KOSPI200 Options data...
INFO  - ✓ Loaded 82 KOSPI200 option contracts
INFO  - ========================================
INFO  - KRX data load completed successfully!
INFO  - ========================================
INFO  - ✓ Real KRX data loaded successfully!
INFO  - Total: 6 futures, 82 options
```

### 실패 시 (샘플 데이터 생성)

```
INFO  - Attempting to load real KRX data...
WARN  - Could not load real KRX data: Connection refused
INFO  - Loading sample data as fallback...
INFO  - ✓ Loaded 6 futures contracts
INFO  - ✓ Loaded 82 option contracts
INFO  - ========================================
INFO  - Initial data load completed!
INFO  - Total: 6 futures, 82 options
```

---

## 8️⃣ KRX API 제한사항

### 공개 API 특성

- ✅ **무료** - 인증키 불필요
- ⚠️ **일별 데이터만** - 실시간 데이터 아님
- ⚠️ **종가 데이터** - Tick 데이터 없음
- ⚠️ **Rate Limit** - 과도한 요청 시 차단 가능

### 실시간 데이터를 원한다면?

**증권사 API 연동 필요:**
1. **키움증권 OpenAPI** (무료)
2. **이베스트투자증권 xingAPI** (무료)
3. **LS증권 XingAPI** (무료)
4. **한국투자증권 KIS API** (유료)

---

## 9️⃣ 데이터 정확성

### ✅ KRX 공식 데이터
- 한국거래소 공식 발표 데이터
- 종가, 거래량, 미결제약정 정확
- 금융기관에서도 사용하는 데이터

### ⚠️ 시뮬레이션 데이터 (장 중)
- 현재는 랜덤 생성 데이터
- 실제 호가/체결 아님
- **데모/테스트 용도**

### 🔧 실전 운영 시 권장
- 증권사 API 연동
- 실시간 Tick 데이터 수신
- WebSocket으로 실시간 전송

---

## 🎯 요약

| 구분 | 데이터 출처 | 갱신 주기 |
|------|------------|-----------|
| **서버 시작 시** | KRX 공식 API (전거래일 종가) | 1회 |
| **장 중 (실시간)** | 시뮬레이션 (랜덤) | 1초 |
| **장 마감** | 전거래일 데이터 유지 | 갱신 없음 |

**현재 상태:**
- ✅ 전거래일 **실제 KRX 데이터** 로드
- ✅ 장 중 시뮬레이션으로 움직임 표현
- ✅ 장 마감 시 전거래일 데이터 표시

**향후 개선:**
- 🔧 증권사 API 연동 → 실시간 실제 데이터
- 🔧 WebSocket 실시간 Tick 데이터
- 🔧 호가창 실시간 업데이트

---

## 📞 문의

데이터 소스나 API 연동 관련 질문이 있으시면 말씀해주세요!

**접속 주소:** http://localhost:8080
